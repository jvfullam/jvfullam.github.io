<!doctype html>
<html>
  <head>
    <title>CS 416</title>
  </head>
  <body>
    <h1>Narrative Visualization Project</h1>
	<p>Data
	  <ul><a href="https://fred.stlouisfed.org/series/MORTGAGE30US">Average 30-Year Fixed Rate Mortgage</a></ul>
	  <ul><a href="https://fred.stlouisfed.org/series/CPIAUCSL">Consumer Price Index</a></ul>
	  <ul><a href="https://fred.stlouisfed.org/series/MSPUS">Median Sales Price</a></ul>
	</p>
	<h2>30 Year Mortage Rate</h2>
	<svg id="scene1"></svg>
	<h2>Median Sales Price</h2>
	<svg id="scene2"></svg>
	<h2>Median Monthly Payment</h2>
	<svg id="scene3"></svg>
  </body>
  <style>
  body {
    max-width: 600px;
	margin: auto;
  }
  h2 {
    text-align: center;
  }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  function getMonthlyPayment(msp, m30) {
    var P = msp * 0.8; // principle loan amount
    var I = m30 * 0.01 / 12; // monthly interest rate
	var N = 12 * 30; // total monthly payments
	var tmp = (1+I)**N;
    return P * (I * tmp) / (tmp - 1);
  }
  
  function getYearQuarter(d) {
    date = d3.timeParse("%Y-%m-%d")(d);
	date.setDate(1);
	date.setMonth(Math.floor(date.getMonth() / 3) * 3);
	return date;
  }
  
  var CPI = d3.csv("https://jvfullam.github.io/cs416/CPI.csv", r => { 
	return {date: getYearQuarter(r.DATE), cpi: parseFloat(r.CPIAUCSL)};
  });
  
  var MSP = d3.csv("https://jvfullam.github.io/cs416/MSP.csv", r => { 
	return {date: getYearQuarter(r.DATE), msp: parseFloat(r.MSPUS)};
  });
  
  var M30 = d3.csv("https://jvfullam.github.io/cs416/M30.csv", r => { 
	return {date: getYearQuarter(r.DATE), m30: parseFloat(r.MORTGAGE30US)};
  });
  
  var DATA = Promise.all([CPI, MSP, M30]).then(([cpi, msp, m30]) => {
    var data = [];
    
    var cpiIdx = 0;
	var mspIdx = 0;
	var m30Idx = 0;
	
	var date;	
	while(cpiIdx < cpi.length && mspIdx < msp.length && m30Idx < m30.length) {
	  date = cpi[cpiIdx].date;
	  if (msp[mspIdx].date > date) {
	    date = msp[mspIdx].date;
	  }
	  if (m30[m30Idx].date > date) {
	    date = m30[m30Idx].date;
	  }
	  
	  while (cpiIdx < cpi.length && cpi[cpiIdx].date < date) {
	    cpiIdx++;
	  }
	  while (mspIdx < msp.length && msp[mspIdx].date < date) {
	    mspIdx++;
	  }
	  while (m30Idx < m30.length && m30[m30Idx].date < date) {
	    m30Idx++;
	  }
	  
	  var cpiSumCnt = [0, 0];
	  while (cpiIdx < cpi.length && cpi[cpiIdx].date <= date) {
	    cpiSumCnt[0] += cpi[cpiIdx].cpi;
		cpiSumCnt[1] += 1;
		cpiIdx++;
	  }
	  var mspSumCnt = [0, 0];
	  while (mspIdx < msp.length && msp[mspIdx].date <= date) {
	    mspSumCnt[0] += msp[mspIdx].msp;
		mspSumCnt[1] += 1;
		mspIdx++;
	  }
	  var m30SumCnt = [0, 0];
	  while (m30Idx < m30.length && m30[m30Idx].date <= date) {
	    m30SumCnt[0] += m30[m30Idx].m30;
		m30SumCnt[1] += 1;
		m30Idx++;
	  }
	  
	  data.push({
	    date: date,
		cpi: cpiSumCnt[0]/cpiSumCnt[1],
		msp: mspSumCnt[0]/mspSumCnt[1],
		m30: m30SumCnt[0]/m30SumCnt[1]
	  });
	}
	
	var lastCpi = data[data.length - 1].cpi
	for (var i=0; i<data.length; i++) {
	  data[i].mspa = data[i].msp * lastCpi / data[i].cpi;
	  data[i].mmp = getMonthlyPayment(data[i].msp, data[i].m30);
	  data[i].mmpa = data[i].mmp * lastCpi / data[i].cpi;
	}
	
	console.log(data);
	return data;
  });
  
  var width = 600;
  var height1 = 200;
  
  var svg1 = d3.select("#scene1").attr("width", width).attr("height", height1);
  
  var padding = {top: 10, right: 50, bottom: 30, left: 50};
  width -= (padding.left + padding.right);
  height1 -= (padding.top + padding.bottom);
  
  svg1 = svg1.append("g").attr("transform", "translate(" + padding.left + ", " + padding.top + ")");
  
  DATA.then(data => {
	var x = d3.scaleTime()
	  .domain(d3.extent(data, d => d.date))
      .range([0, width]);
	svg1.append("g")
      .attr("transform", "translate(0," + height1 + ")")
      .call(d3.axisBottom(x));
	
	var y = d3.scaleLinear()
	  .domain([0, d3.max(data, d => (d.m30/100))])
      .range([height1, 0]);
	svg1.append("g")
      .call(d3.axisLeft(y).tickFormat(d3.format(".0%")));
		
	svg1.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(d => x(d.date))
        .y(d => y(d.m30/100))
      );
  });
  
  var width = 600;
  var height = 400;
  
  var svg2 = d3.select("#scene2").attr("width", width).attr("height", height);
  
  var padding = {top: 10, right: 50, bottom: 30, left: 50};
  width -= (padding.left + padding.right);
  height -= (padding.top + padding.bottom);
  
  svg2 = svg2.append("g").attr("transform", "translate(" + padding.left + ", " + padding.top + ")");
  
  DATA.then(data => {
	var x = d3.scaleTime()
	  .domain(d3.extent(data, d => d.date))
      .range([0, width]);
	svg2.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));
	
	var y = d3.scaleLinear()
	  .domain([0, d3.max(data, d => Math.max(d.msp, d.mspa))])
      .range([height, 0]);
	svg2.append("g")
      .call(d3.axisLeft(y));
		
	svg2.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(d => x(d.date))
        .y(d => y(d.msp))
      );
	
	svg2.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "red")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(d => x(d.date))
        .y(d => y(d.mspa))
      );
  });
  
  var width = 600;
  var height = 400;
  
  var svg3 = d3.select("#scene3").attr("width", width).attr("height", height);
  
  var padding = {top: 10, right: 50, bottom: 30, left: 50};
  width -= (padding.left + padding.right);
  height -= (padding.top + padding.bottom);
  
  svg3 = svg3.append("g").attr("transform", "translate(" + padding.left + ", " + padding.top + ")");
  
  DATA.then(data => {
	var x = d3.scaleTime()
	  .domain(d3.extent(data, d => d.date))
      .range([0, width]);
	svg3.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));
	
	var y = d3.scaleLinear()
	  .domain([0, d3.max(data, d => Math.max(d.mmp, d.mmpa))])
      .range([height, 0]);
	svg3.append("g")
      .call(d3.axisLeft(y));
		
	svg3.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(d => x(d.date))
        .y(d => y(d.mmp))
      );
	
	svg3.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "red")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(d => x(d.date))
        .y(d => y(d.mmpa))
      );
  });
  </script>
</html>